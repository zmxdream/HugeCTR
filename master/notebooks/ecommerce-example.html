<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Merlin ETL, training and inference demo on the e-Commerce behavior data &mdash; Merlin HugeCTR  documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="HugeCTR demo on Movie lens data" href="movie-lens-example.html" />
    <link rel="prev" title="HugeCTR Continuous Training" href="continuous_training.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Merlin HugeCTR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">HugeCTR Library</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hugectr_user_guide.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_core_features.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_feature_details_intro.html">Features in Detail</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../hugectr_example_notebooks.html">Example Notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hugectr_wdl_prediction.html">HugeCTR Wide and Deep Model with Criteo</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr2onnx_demo.html">HugeCTR to ONNX Converter</a></li>
<li class="toctree-l2"><a class="reference internal" href="continuous_training.html">HugeCTR Continuous Training</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Merlin ETL, training and inference demo on the e-Commerce behavior data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Table-of-Contents">Table of Contents</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Data-extraction-and-initial-preprocessing">Data extraction and initial preprocessing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Prepare-train/validation/test-data">Prepare train/validation/test data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Initialize-Dask-GPU-cluster">Initialize Dask GPU cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Define-NVTabular-dataset">Define NVTabular dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Preprocessing-and-feature-engineering">Preprocessing and feature engineering</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Visualize-workflow-as-a-DAG">Visualize workflow as a DAG</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Executing-the-workflow">Executing the workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Verify-the-preprocessed-data">Verify the preprocessed data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Getting-the-embedding-size">Getting the embedding size</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Preparing-the-training-Python-script-for-HugeCTR">Preparing the training Python script for HugeCTR</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Prepare-the-inference-session">Prepare the inference session</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Reading-and-prepare-the-data">Reading and prepare the data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Converting-data-to-CSR-format">Converting data to CSR format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Computing-the-test-AUC-value">Computing the test AUC value</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="movie-lens-example.html">HugeCTR demo on Movie lens data</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr_criteo.html">HugeCTR Python Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_gpu_offline_inference.html">Multi-GPU Offline Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="hps_demo.html">Hierarchical Parameter Server Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi-modal-data/00-Intro.html">Training Recommender Systems on Multi-modal Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi-modal-data/01-Download-Convert.html">MovieLens-25M: Download and Convert</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi-modal-data/03-Feature-Extraction-Poster.html">Movie Poster Feature Extraction with ResNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi-modal-data/04-Feature-Extraction-Text.html">Movie Synopsis Feature Extraction with Bart text summarization</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi-modal-data/04-Feature-Extraction-Text.html#Download-pretrained-BART-model">Download pretrained BART model</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi-modal-data/05-Create-Feature-Store.html">Creating Multi-Modal Movie Feature Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi-modal-data/06-ETL-with-NVTabular.html">ETL with NVTabular</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi-modal-data/07-Training-with-HugeCTR.html">Training HugeCTR Model with Pretrained Embeddings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_contributor_guide.html">Contributing to HugeCTR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional_resources.html">Additional Resources</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Merlin HugeCTR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../hugectr_example_notebooks.html">HugeCTR Example Notebooks</a> &raquo;</li>
      <li>Merlin ETL, training and inference demo on the e-Commerce behavior data</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<p><img alt="71d94e6a4db9428b94366441dbbbe64e" src="http://developer.download.nvidia.com/compute/machine-learning/frameworks/nvidia_logo.png" /></p>
<div class="section" id="Merlin-ETL,-training-and-inference-demo-on-the-e-Commerce-behavior-data">
<h1>Merlin ETL, training and inference demo on the e-Commerce behavior data<a class="headerlink" href="#Merlin-ETL,-training-and-inference-demo-on-the-e-Commerce-behavior-data" title="Permalink to this headline"></a></h1>
<div class="section" id="Overview">
<h2>Overview<a class="headerlink" href="#Overview" title="Permalink to this headline"></a></h2>
<p>In this tutorial, we will be using the <a class="reference external" href="https://www.kaggle.com/mkechinov/ecommerce-behavior-data-from-multi-category-store">eCommerce behavior data from multi category store</a> from <a class="reference external" href="https://rees46.com/">REES46 Marketing Platform</a> as our dataset. This tutorial is built upon the NVIDIA RecSys 2020 <a class="reference external" href="https://recsys.acm.org/recsys20/tutorials/">tutorial</a>.</p>
<p>This jupyter notebook provides the code to preprocess the dataset and generate the train, validation and test sets for the remainder of the tutorial. We define our own goal and filter the dataset accordingly.</p>
<p>For our tutorial, we decided that our goal is to predict if a user purchased an item:</p>
<ul class="simple">
<li><p>Positive: User purchased an item</p></li>
<li><p>Negative: User added an item to the cart, but did not purchase it (in the same session)</p></li>
</ul>
<p>We split the dataset into train, validation and test set by the timestamp: - Training: October 2019 - February 2020 - Validation: March 2020 - Test: April 2020</p>
<p>We remove AddToCart Events from a session, if in the same session the same item was purchased.</p>
</div>
<div class="section" id="Table-of-Contents">
<h2>Table of Contents<a class="headerlink" href="#Table-of-Contents" title="Permalink to this headline"></a></h2>
<ol class="arabic simple">
<li><p><a class="reference external" href="#1">Data</a></p></li>
<li><p><a class="reference external" href="#2">ETL with NVTabular</a></p></li>
<li><p><a class="reference external" href="#3">Training with HugeCTR</a></p></li>
<li><p><a class="reference external" href="#4">HugeCTR inference</a></p></li>
</ol>
<p>## 1. Data First, we download and unzip the raw data.</p>
<p>Note: the dataset is ~11GB and will take a while to download.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-bash notranslate"><div class="highlight"><pre><span></span>%%bash
<span class="nb">export</span> <span class="nv">HOME</span><span class="o">=</span><span class="nv">$PWD</span>
pip install gdown --user
~/.local/bin/gdown  https://drive.google.com/uc?id<span class="o">=</span><span class="m">1</span>-Rov9fFtGJqb7_ePc6qH-Rhzxn0cIcKB
~/.local/bin/gdown  https://drive.google.com/uc?id<span class="o">=</span><span class="m">1</span>-Rov9fFtGJqb7_ePc6qH-Rhzxn0cIcKB
~/.local/bin/gdown  https://drive.google.com/uc?id<span class="o">=</span>1zr_RXpGvOWN2PrWI6itWL8HnRsCpyqz8
~/.local/bin/gdown  https://drive.google.com/uc?id<span class="o">=</span>1g5WoIgLe05UMdREbxAjh0bEFgVCjA1UL
~/.local/bin/gdown  https://drive.google.com/uc?id<span class="o">=</span>1qZIwMbMgMmgDC5EoMdJ8aI9lQPsWA3-P
~/.local/bin/gdown  https://drive.google.com/uc?id<span class="o">=</span>1x5ohrrZNhWQN4Q-zww0RmXOwctKHH9PT
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import glob

list_files = glob.glob(&#39;*.csv.gz&#39;)
list_files
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;2019-Dec.csv.gz&#39;,
 &#39;2020-Apr.csv.gz&#39;,
 &#39;2020-Mar.csv.gz&#39;,
 &#39;2020-Feb.csv.gz&#39;,
 &#39;2020-Jan.csv.gz&#39;]
</pre></div></div>
</div>
<div class="section" id="Data-extraction-and-initial-preprocessing">
<h3>Data extraction and initial preprocessing<a class="headerlink" href="#Data-extraction-and-initial-preprocessing" title="Permalink to this headline"></a></h3>
<p>We extract a few relevant columns from the raw datasets and parse date columns into several atomic colunns (day, month…).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import pandas as pd
import numpy as np
from tqdm import tqdm

def process_files(file):
    df_tmp = pd.read_csv(file, compression=&#39;gzip&#39;)
    df_tmp[&#39;session_purchase&#39;] =  df_tmp[&#39;user_session&#39;] + &#39;_&#39; + df_tmp[&#39;product_id&#39;].astype(str)
    df_purchase = df_tmp[df_tmp[&#39;event_type&#39;]==&#39;purchase&#39;]
    df_cart = df_tmp[df_tmp[&#39;event_type&#39;]==&#39;cart&#39;]
    df_purchase = df_purchase[df_purchase[&#39;session_purchase&#39;].isin(df_cart[&#39;session_purchase&#39;])]
    df_cart = df_cart[~(df_cart[&#39;session_purchase&#39;].isin(df_purchase[&#39;session_purchase&#39;]))]
    df_cart[&#39;target&#39;] = 0
    df_purchase[&#39;target&#39;] = 1
    df = pd.concat([df_cart, df_purchase])
    df = df.drop(&#39;category_id&#39;, axis=1)
    df = df.drop(&#39;session_purchase&#39;, axis=1)
    df[[&#39;cat_0&#39;, &#39;cat_1&#39;, &#39;cat_2&#39;, &#39;cat_3&#39;]] = df[&#39;category_code&#39;].str.split(&quot;\.&quot;, n = 3, expand = True).fillna(&#39;NA&#39;)
    df[&#39;brand&#39;] = df[&#39;brand&#39;].fillna(&#39;NA&#39;)
    df = df.drop(&#39;category_code&#39;, axis=1)
    df[&#39;timestamp&#39;] = pd.to_datetime(df[&#39;event_time&#39;].str.replace(&#39; UTC&#39;, &#39;&#39;))
    df[&#39;ts_hour&#39;] = df[&#39;timestamp&#39;].dt.hour
    df[&#39;ts_minute&#39;] = df[&#39;timestamp&#39;].dt.minute
    df[&#39;ts_weekday&#39;] = df[&#39;timestamp&#39;].dt.weekday
    df[&#39;ts_day&#39;] = df[&#39;timestamp&#39;].dt.day
    df[&#39;ts_month&#39;] = df[&#39;timestamp&#39;].dt.month
    df[&#39;ts_year&#39;] = df[&#39;timestamp&#39;].dt.year
    df.to_csv(&#39;./dataset/&#39; + file.replace(&#39;.gz&#39;, &#39;&#39;), index=False)

!mkdir ./dataset
for file in tqdm(list_files):
    print(file)
    process_files(file)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
  0%|                                                                                   | 0/5 [00:00&lt;?, ?it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2019-Dec.csv.gz
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 20%|██████████████▊                                                           | 1/5 [04:16&lt;17:05, 256.45s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2020-Apr.csv.gz
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 40%|█████████████████████████████▌                                            | 2/5 [08:34&lt;12:51, 257.29s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2020-Mar.csv.gz
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 60%|████████████████████████████████████████████▍                             | 3/5 [12:02&lt;07:49, 234.67s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2020-Feb.csv.gz
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 80%|███████████████████████████████████████████████████████████▏              | 4/5 [15:30&lt;03:44, 224.22s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2020-Jan.csv.gz
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████████████████████████████████████████████████████████████████████| 5/5 [19:05&lt;00:00, 229.04s/it]
</pre></div></div>
</div>
</div>
<div class="section" id="Prepare-train/validation/test-data">
<h3>Prepare train/validation/test data<a class="headerlink" href="#Prepare-train/validation/test-data" title="Permalink to this headline"></a></h3>
<p>Next, we split the data into train, validation and test sets. We will be using 3 months for training, 1 month for validation and 1 month for testing.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>lp = []
list_files = glob.glob(&#39;./dataset/*.csv&#39;)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!ls -l ./dataset/*.csv
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
-rw-r--r-- 1 root dip 479323170 Nov 16 22:47 ./dataset/2019-Dec.csv
-rw-r--r-- 1 root dip 455992639 Nov 16 22:51 ./dataset/2020-Apr.csv
-rw-r--r-- 1 root dip 453967664 Nov 16 22:58 ./dataset/2020-Feb.csv
-rw-r--r-- 1 root dip 375205173 Nov 16 23:02 ./dataset/2020-Jan.csv
-rw-r--r-- 1 root dip 403896607 Nov 16 22:55 ./dataset/2020-Mar.csv
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for file in list_files:
    lp.append(pd.read_csv(file))
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df = pd.concat(lp)
df.shape
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(13184044, 19)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df_test = df[df[&#39;ts_month&#39;]==4]
df_valid = df[df[&#39;ts_month&#39;]==3]
df_train = df[(df[&#39;ts_month&#39;]!=3)&amp;(df[&#39;ts_month&#39;]!=4)]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df_train.shape, df_valid.shape, df_test.shape
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((7949839, 19), (2461719, 19), (2772486, 19))
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!mkdir -p ./data
df_train.to_parquet(&#39;./data/train.parquet&#39;, index=False)
df_valid.to_parquet(&#39;./data/valid.parquet&#39;, index=False)
df_test.to_parquet(&#39;./data/test.parquet&#39;, index=False)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df_train.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_time</th>
      <th>event_type</th>
      <th>product_id</th>
      <th>brand</th>
      <th>price</th>
      <th>user_id</th>
      <th>user_session</th>
      <th>target</th>
      <th>cat_0</th>
      <th>cat_1</th>
      <th>cat_2</th>
      <th>cat_3</th>
      <th>timestamp</th>
      <th>ts_hour</th>
      <th>ts_minute</th>
      <th>ts_weekday</th>
      <th>ts_day</th>
      <th>ts_month</th>
      <th>ts_year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2020-02-01 00:00:18 UTC</td>
      <td>cart</td>
      <td>100065078</td>
      <td>xiaomi</td>
      <td>568.61</td>
      <td>526615078</td>
      <td>5f0aab9f-f92e-4eff-b0d2-fcec5f553f01</td>
      <td>0</td>
      <td>construction</td>
      <td>tools</td>
      <td>light</td>
      <td>NaN</td>
      <td>2020-02-01 00:00:18</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2020</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2020-02-01 00:00:18 UTC</td>
      <td>cart</td>
      <td>5701246</td>
      <td>NaN</td>
      <td>24.43</td>
      <td>563902689</td>
      <td>76cc9152-8a9f-43e9-b98a-ee484510f379</td>
      <td>0</td>
      <td>electronics</td>
      <td>video</td>
      <td>tv</td>
      <td>NaN</td>
      <td>2020-02-01 00:00:18</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2020</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2020-02-01 00:00:31 UTC</td>
      <td>cart</td>
      <td>14701533</td>
      <td>NaN</td>
      <td>154.42</td>
      <td>520953435</td>
      <td>5f1c7752-cf92-41fc-9a16-e8897a90eee8</td>
      <td>0</td>
      <td>electronics</td>
      <td>video</td>
      <td>projector</td>
      <td>NaN</td>
      <td>2020-02-01 00:00:31</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2020</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2020-02-01 00:00:40 UTC</td>
      <td>cart</td>
      <td>1004855</td>
      <td>xiaomi</td>
      <td>123.30</td>
      <td>519236281</td>
      <td>e512f514-dc7f-4fc9-9042-e3955989d395</td>
      <td>0</td>
      <td>construction</td>
      <td>tools</td>
      <td>light</td>
      <td>NaN</td>
      <td>2020-02-01 00:00:40</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2020</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2020-02-01 00:00:47 UTC</td>
      <td>cart</td>
      <td>1005100</td>
      <td>samsung</td>
      <td>140.28</td>
      <td>550305600</td>
      <td>bd7a37b6-420d-4575-8852-ac825aff39b5</td>
      <td>0</td>
      <td>construction</td>
      <td>tools</td>
      <td>light</td>
      <td>NaN</td>
      <td>2020-02-01 00:00:47</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2020</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>## 2. Preprocessing with NVTabular</p>
<p>Next, we will use NVTabular for preprocessing and engineering more features.</p>
<p>But first, we need to import the necessary libraries and initialize a Dask GPU cluster for computation.</p>
</div>
<div class="section" id="Initialize-Dask-GPU-cluster">
<h3>Initialize Dask GPU cluster<a class="headerlink" href="#Initialize-Dask-GPU-cluster" title="Permalink to this headline"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Standard Libraries
import os
from time import time
import re
import shutil
import glob
import warnings

# External Dependencies
import numpy as np
import pandas as pd
import cupy as cp
import cudf
import dask_cudf
from dask_cuda import LocalCUDACluster
from dask.distributed import Client
from dask.utils import parse_bytes
from dask.delayed import delayed
import rmm

# NVTabular
import nvtabular as nvt
import nvtabular.ops as ops
from nvtabular.io import Shuffle
from nvtabular.utils import _pynvml_mem_size, device_mem_size

print(nvt.__version__)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.7.1
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># define some information about where to get our data
BASE_DIR = &quot;./nvtabular_temp&quot;
!rm -r $BASE_DIR &amp;&amp; mkdir $BASE_DIR
input_path = &#39;./dataset&#39;
dask_workdir = os.path.join(BASE_DIR, &quot;workdir&quot;)
output_path = os.path.join(BASE_DIR, &quot;output&quot;)
stats_path = os.path.join(BASE_DIR, &quot;stats&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
rm: cannot remove &#39;./nvtabular_temp&#39;: No such file or directory
</pre></div></div>
</div>
<p>This example was tested on a DGX server with 8 GPUs. If you have less GPUs, modify the <code class="docutils literal notranslate"><span class="pre">NUM_GPUS</span></code> variable accordingly.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>NUM_GPUS = [0,1,2,3,4,5,6,7]
#NUM_GPUS = [0]

# Dask dashboard
dashboard_port = &quot;8787&quot;

# Deploy a Single-Machine Multi-GPU Cluster
protocol = &quot;tcp&quot;             # &quot;tcp&quot; or &quot;ucx&quot;
visible_devices = &quot;,&quot;.join([str(n) for n in NUM_GPUS])  # Delect devices to place workers
device_limit_frac = 0.5      # Spill GPU-Worker memory to host at this limit.
device_pool_frac = 0.6
part_mem_frac = 0.05

# Use total device size to calculate args.device_limit_frac
device_size = device_mem_size(kind=&quot;total&quot;)
device_limit = int(device_limit_frac * device_size)
device_pool_size = int(device_pool_frac * device_size)
part_size = int(part_mem_frac * device_size)

# Check if any device memory is already occupied
&quot;&quot;&quot;
for dev in visible_devices.split(&quot;,&quot;):
    fmem = _pynvml_mem_size(kind=&quot;free&quot;, index=int(dev))
    used = (device_size - fmem) / 1e9
    if used &gt; 1.0:
        warnings.warn(f&quot;BEWARE - {used} GB is already occupied on device {int(dev)}!&quot;)
&quot;&quot;&quot;

cluster = None               # (Optional) Specify existing scheduler port
if cluster is None:
    cluster = LocalCUDACluster(
        protocol = protocol,
        n_workers=len(visible_devices.split(&quot;,&quot;)),
        CUDA_VISIBLE_DEVICES = visible_devices,
        device_memory_limit = device_limit,
        local_directory=dask_workdir,
        dashboard_address=&quot;:&quot; + dashboard_port,
    )

# Create the distributed client
client = Client(cluster)
client
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
distributed.preloading - INFO - Import preload module: dask_cuda.initialize
distributed.preloading - INFO - Import preload module: dask_cuda.initialize
distributed.preloading - INFO - Import preload module: dask_cuda.initialize
distributed.preloading - INFO - Import preload module: dask_cuda.initialize
distributed.preloading - INFO - Import preload module: dask_cuda.initialize
distributed.preloading - INFO - Import preload module: dask_cuda.initialize
distributed.preloading - INFO - Import preload module: dask_cuda.initialize
distributed.preloading - INFO - Import preload module: dask_cuda.initialize
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
    <div>
        <div style="
            width: 24px;
            height: 24px;
            background-color: #e1e1e1;
            border: 3px solid #9D9D9D;
            border-radius: 5px;
            position: absolute;"> </div>
        <div style="margin-left: 48px;">
            <h3 style="margin-bottom: 0px;">Client</h3>
            <p style="color: #9D9D9D; margin-bottom: 0px;">Client-5fa9de34-4731-11ec-81a0-0242c0a88002</p>
            <table style="width: 100%; text-align: left;">

        <tr>
            <td style="text-align: left;"><strong>Connection method:</strong> Cluster object</td>
            <td style="text-align: left;"><strong>Cluster type:</strong> LocalCUDACluster</td>
        </tr>

        <tr>
            <td style="text-align: left;">
                <strong>Dashboard: </strong>
                <a href="http://127.0.0.1:8787/status">http://127.0.0.1:8787/status</a>
            </td>
            <td style="text-align: left;"></td>
        </tr>

            </table>

        <details>
        <summary style="margin-bottom: 20px;"><h3 style="display: inline;">Cluster Info</h3></summary>

    <div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-mod-trusted jp-OutputArea-output">
        <div style="
            width: 24px;
            height: 24px;
            background-color: #e1e1e1;
            border: 3px solid #9D9D9D;
            border-radius: 5px;
            position: absolute;"> </div>
        <div style="margin-left: 48px;">
            <h3 style="margin-bottom: 0px; margin-top: 0px;">LocalCUDACluster</h3>
            <p style="color: #9D9D9D; margin-bottom: 0px;">280d3dd0</p>
            <table style="width: 100%; text-align: left;">

    <tr>
        <td style="text-align: left;"><strong>Status:</strong> running</td>
        <td style="text-align: left;"><strong>Using processes:</strong> True</td>
    </tr>

    <tr>
        <td style="text-align: left;">
            <strong>Dashboard:</strong> <a href="http://127.0.0.1:8787/status">http://127.0.0.1:8787/status</a>
        </td>
        <td style="text-align: left;"><strong>Workers:</strong> 8</td>
    </tr>
    <tr>
        <td style="text-align: left;">
            <strong>Total threads:</strong>
            8
        </td>
        <td style="text-align: left;">
            <strong>Total memory:</strong>
            503.81 GiB
        </td>
    </tr>

            </table>
            <details>
            <summary style="margin-bottom: 20px;"><h3 style="display: inline;">Scheduler Info</h3></summary>

<div style="">

    <div>
        <div style="
            width: 24px;
            height: 24px;
            background-color: #FFF7E5;
            border: 3px solid #FF6132;
            border-radius: 5px;
            position: absolute;"> </div>
        <div style="margin-left: 48px;">
            <h3 style="margin-bottom: 0px;">Scheduler</h3>
            <p style="color: #9D9D9D; margin-bottom: 0px;">Scheduler-e2967024-5ba6-46fa-889b-ce05595cfe32</p>
            <table style="width: 100%; text-align: left;">
                <tr>
                    <td style="text-align: left;"><strong>Comm:</strong> tcp://127.0.0.1:42281</td>
                    <td style="text-align: left;"><strong>Workers:</strong> 8</td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Dashboard:</strong> <a href="http://127.0.0.1:8787/status">http://127.0.0.1:8787/status</a>
                    </td>
                    <td style="text-align: left;">
                        <strong>Total threads:</strong>
                        8
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Started:</strong>
                        Just now
                    </td>
                    <td style="text-align: left;">
                        <strong>Total memory:</strong>
                        503.81 GiB
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <details style="margin-left: 48px;">
    <summary style="margin-bottom: 20px;"><h3 style="display: inline;">Workers</h3></summary>

    <div style="margin-bottom: 20px;">
        <div style="width: 24px;
                    height: 24px;
                    background-color: #DBF5FF;
                    border: 3px solid #4CC9FF;
                    border-radius: 5px;
                    position: absolute;"> </div>
        <div style="margin-left: 48px;">
        <details>
            <summary>
                <h4 style="margin-bottom: 0px; display: inline;">Worker: 0</h4>
            </summary>
            <table style="width: 100%; text-align: left;">
                <tr>
                    <td style="text-align: left;"><strong>Comm: </strong> tcp://127.0.0.1:45134</td>
                    <td style="text-align: left;"><strong>Total threads: </strong> 1</td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Dashboard: </strong>
                        <a href="http://127.0.0.1:45519/status">http://127.0.0.1:45519/status</a>
                    </td>
                    <td style="text-align: left;">
                        <strong>Memory: </strong>
                        62.98 GiB
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;"><strong>Nanny: </strong> tcp://127.0.0.1:40585</td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: left;">
                        <strong>Local directory: </strong>
                        /hugectr/notebooks/nvtabular_temp/workdir/dask-worker-space/worker-m2ipvyh1
                    </td>
                </tr>

        <tr>
            <td style="text-align: left;">
                <strong>GPU: </strong>Tesla P100-SXM2-16GB
            </td>
            <td style="text-align: left;">
                <strong>GPU memory: </strong>
                15.90 GiB
            </td>
        </tr>


            </table>
        </details>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <div style="width: 24px;
                    height: 24px;
                    background-color: #DBF5FF;
                    border: 3px solid #4CC9FF;
                    border-radius: 5px;
                    position: absolute;"> </div>
        <div style="margin-left: 48px;">
        <details>
            <summary>
                <h4 style="margin-bottom: 0px; display: inline;">Worker: 1</h4>
            </summary>
            <table style="width: 100%; text-align: left;">
                <tr>
                    <td style="text-align: left;"><strong>Comm: </strong> tcp://127.0.0.1:45442</td>
                    <td style="text-align: left;"><strong>Total threads: </strong> 1</td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Dashboard: </strong>
                        <a href="http://127.0.0.1:36563/status">http://127.0.0.1:36563/status</a>
                    </td>
                    <td style="text-align: left;">
                        <strong>Memory: </strong>
                        62.98 GiB
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;"><strong>Nanny: </strong> tcp://127.0.0.1:33615</td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: left;">
                        <strong>Local directory: </strong>
                        /hugectr/notebooks/nvtabular_temp/workdir/dask-worker-space/worker-hhdw5hgq
                    </td>
                </tr>

        <tr>
            <td style="text-align: left;">
                <strong>GPU: </strong>Tesla P100-SXM2-16GB
            </td>
            <td style="text-align: left;">
                <strong>GPU memory: </strong>
                15.90 GiB
            </td>
        </tr>


            </table>
        </details>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <div style="width: 24px;
                    height: 24px;
                    background-color: #DBF5FF;
                    border: 3px solid #4CC9FF;
                    border-radius: 5px;
                    position: absolute;"> </div>
        <div style="margin-left: 48px;">
        <details>
            <summary>
                <h4 style="margin-bottom: 0px; display: inline;">Worker: 2</h4>
            </summary>
            <table style="width: 100%; text-align: left;">
                <tr>
                    <td style="text-align: left;"><strong>Comm: </strong> tcp://127.0.0.1:38832</td>
                    <td style="text-align: left;"><strong>Total threads: </strong> 1</td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Dashboard: </strong>
                        <a href="http://127.0.0.1:45537/status">http://127.0.0.1:45537/status</a>
                    </td>
                    <td style="text-align: left;">
                        <strong>Memory: </strong>
                        62.98 GiB
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;"><strong>Nanny: </strong> tcp://127.0.0.1:34857</td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: left;">
                        <strong>Local directory: </strong>
                        /hugectr/notebooks/nvtabular_temp/workdir/dask-worker-space/worker-3xv1lvg4
                    </td>
                </tr>

        <tr>
            <td style="text-align: left;">
                <strong>GPU: </strong>Tesla P100-SXM2-16GB
            </td>
            <td style="text-align: left;">
                <strong>GPU memory: </strong>
                15.90 GiB
            </td>
        </tr>


            </table>
        </details>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <div style="width: 24px;
                    height: 24px;
                    background-color: #DBF5FF;
                    border: 3px solid #4CC9FF;
                    border-radius: 5px;
                    position: absolute;"> </div>
        <div style="margin-left: 48px;">
        <details>
            <summary>
                <h4 style="margin-bottom: 0px; display: inline;">Worker: 3</h4>
            </summary>
            <table style="width: 100%; text-align: left;">
                <tr>
                    <td style="text-align: left;"><strong>Comm: </strong> tcp://127.0.0.1:33468</td>
                    <td style="text-align: left;"><strong>Total threads: </strong> 1</td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Dashboard: </strong>
                        <a href="http://127.0.0.1:34645/status">http://127.0.0.1:34645/status</a>
                    </td>
                    <td style="text-align: left;">
                        <strong>Memory: </strong>
                        62.98 GiB
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;"><strong>Nanny: </strong> tcp://127.0.0.1:33516</td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: left;">
                        <strong>Local directory: </strong>
                        /hugectr/notebooks/nvtabular_temp/workdir/dask-worker-space/worker-_v4e6b68
                    </td>
                </tr>

        <tr>
            <td style="text-align: left;">
                <strong>GPU: </strong>Tesla P100-SXM2-16GB
            </td>
            <td style="text-align: left;">
                <strong>GPU memory: </strong>
                15.90 GiB
            </td>
        </tr>


            </table>
        </details>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <div style="width: 24px;
                    height: 24px;
                    background-color: #DBF5FF;
                    border: 3px solid #4CC9FF;
                    border-radius: 5px;
                    position: absolute;"> </div>
        <div style="margin-left: 48px;">
        <details>
            <summary>
                <h4 style="margin-bottom: 0px; display: inline;">Worker: 4</h4>
            </summary>
            <table style="width: 100%; text-align: left;">
                <tr>
                    <td style="text-align: left;"><strong>Comm: </strong> tcp://127.0.0.1:38052</td>
                    <td style="text-align: left;"><strong>Total threads: </strong> 1</td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Dashboard: </strong>
                        <a href="http://127.0.0.1:33234/status">http://127.0.0.1:33234/status</a>
                    </td>
                    <td style="text-align: left;">
                        <strong>Memory: </strong>
                        62.98 GiB
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;"><strong>Nanny: </strong> tcp://127.0.0.1:42282</td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: left;">
                        <strong>Local directory: </strong>
                        /hugectr/notebooks/nvtabular_temp/workdir/dask-worker-space/worker-lbkl0_sc
                    </td>
                </tr>

        <tr>
            <td style="text-align: left;">
                <strong>GPU: </strong>Tesla P100-SXM2-16GB
            </td>
            <td style="text-align: left;">
                <strong>GPU memory: </strong>
                15.90 GiB
            </td>
        </tr>


            </table>
        </details>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <div style="width: 24px;
                    height: 24px;
                    background-color: #DBF5FF;
                    border: 3px solid #4CC9FF;
                    border-radius: 5px;
                    position: absolute;"> </div>
        <div style="margin-left: 48px;">
        <details>
            <summary>
                <h4 style="margin-bottom: 0px; display: inline;">Worker: 5</h4>
            </summary>
            <table style="width: 100%; text-align: left;">
                <tr>
                    <td style="text-align: left;"><strong>Comm: </strong> tcp://127.0.0.1:46068</td>
                    <td style="text-align: left;"><strong>Total threads: </strong> 1</td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Dashboard: </strong>
                        <a href="http://127.0.0.1:34702/status">http://127.0.0.1:34702/status</a>
                    </td>
                    <td style="text-align: left;">
                        <strong>Memory: </strong>
                        62.98 GiB
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;"><strong>Nanny: </strong> tcp://127.0.0.1:39148</td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: left;">
                        <strong>Local directory: </strong>
                        /hugectr/notebooks/nvtabular_temp/workdir/dask-worker-space/worker-47f2dcfj
                    </td>
                </tr>

        <tr>
            <td style="text-align: left;">
                <strong>GPU: </strong>Tesla P100-SXM2-16GB
            </td>
            <td style="text-align: left;">
                <strong>GPU memory: </strong>
                15.90 GiB
            </td>
        </tr>


            </table>
        </details>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <div style="width: 24px;
                    height: 24px;
                    background-color: #DBF5FF;
                    border: 3px solid #4CC9FF;
                    border-radius: 5px;
                    position: absolute;"> </div>
        <div style="margin-left: 48px;">
        <details>
            <summary>
                <h4 style="margin-bottom: 0px; display: inline;">Worker: 6</h4>
            </summary>
            <table style="width: 100%; text-align: left;">
                <tr>
                    <td style="text-align: left;"><strong>Comm: </strong> tcp://127.0.0.1:41440</td>
                    <td style="text-align: left;"><strong>Total threads: </strong> 1</td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Dashboard: </strong>
                        <a href="http://127.0.0.1:33288/status">http://127.0.0.1:33288/status</a>
                    </td>
                    <td style="text-align: left;">
                        <strong>Memory: </strong>
                        62.98 GiB
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;"><strong>Nanny: </strong> tcp://127.0.0.1:36099</td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: left;">
                        <strong>Local directory: </strong>
                        /hugectr/notebooks/nvtabular_temp/workdir/dask-worker-space/worker-qq2t20ws
                    </td>
                </tr>

        <tr>
            <td style="text-align: left;">
                <strong>GPU: </strong>Tesla P100-SXM2-16GB
            </td>
            <td style="text-align: left;">
                <strong>GPU memory: </strong>
                15.90 GiB
            </td>
        </tr>


            </table>
        </details>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <div style="width: 24px;
                    height: 24px;
                    background-color: #DBF5FF;
                    border: 3px solid #4CC9FF;
                    border-radius: 5px;
                    position: absolute;"> </div>
        <div style="margin-left: 48px;">
        <details>
            <summary>
                <h4 style="margin-bottom: 0px; display: inline;">Worker: 7</h4>
            </summary>
            <table style="width: 100%; text-align: left;">
                <tr>
                    <td style="text-align: left;"><strong>Comm: </strong> tcp://127.0.0.1:43583</td>
                    <td style="text-align: left;"><strong>Total threads: </strong> 1</td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Dashboard: </strong>
                        <a href="http://127.0.0.1:45175/status">http://127.0.0.1:45175/status</a>
                    </td>
                    <td style="text-align: left;">
                        <strong>Memory: </strong>
                        62.98 GiB
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;"><strong>Nanny: </strong> tcp://127.0.0.1:35315</td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: left;">
                        <strong>Local directory: </strong>
                        /hugectr/notebooks/nvtabular_temp/workdir/dask-worker-space/worker-1v3qmqn5
                    </td>
                </tr>

        <tr>
            <td style="text-align: left;">
                <strong>GPU: </strong>Tesla P100-SXM2-16GB
            </td>
            <td style="text-align: left;">
                <strong>GPU memory: </strong>
                15.90 GiB
            </td>
        </tr>


            </table>
        </details>
        </div>
    </div>

    </details>
</div>

            </details>
        </div>
    </div>

        </details>

        </div>
    </div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!nvidia-smi
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Tue Nov 16 23:03:13 2021
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 450.51.06    Driver Version: 450.51.06    CUDA Version: 11.4     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  Tesla P100-SXM2...  On   | 00000000:06:00.0 Off |                    0 |
| N/A   41C    P0    44W / 300W |    508MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
|   1  Tesla P100-SXM2...  On   | 00000000:07:00.0 Off |                    0 |
| N/A   38C    P0    41W / 300W |    255MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
|   2  Tesla P100-SXM2...  On   | 00000000:0A:00.0 Off |                    0 |
| N/A   38C    P0    44W / 300W |    255MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
|   3  Tesla P100-SXM2...  On   | 00000000:0B:00.0 Off |                    0 |
| N/A   39C    P0    45W / 300W |    255MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
|   4  Tesla P100-SXM2...  On   | 00000000:85:00.0 Off |                    0 |
| N/A   43C    P0    43W / 300W |    255MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
|   5  Tesla P100-SXM2...  On   | 00000000:86:00.0 Off |                    0 |
| N/A   44C    P0    44W / 300W |    255MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
|   6  Tesla P100-SXM2...  On   | 00000000:89:00.0 Off |                    0 |
| N/A   39C    P0    44W / 300W |    255MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
|   7  Tesla P100-SXM2...  On   | 00000000:8A:00.0 Off |                    0 |
| N/A   38C    P0    42W / 300W |    255MiB / 16280MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
+-----------------------------------------------------------------------------+
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Initialize RMM pool on ALL workers
def _rmm_pool():
    rmm.reinitialize(
        # RMM may require the pool size to be a multiple of 256.
        pool_allocator=True,
        initial_pool_size=(device_pool_size // 256) * 256, # Use default size
    )

client.run(_rmm_pool)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;tcp://127.0.0.1:33468&#39;: None,
 &#39;tcp://127.0.0.1:38052&#39;: None,
 &#39;tcp://127.0.0.1:38832&#39;: None,
 &#39;tcp://127.0.0.1:41440&#39;: None,
 &#39;tcp://127.0.0.1:43583&#39;: None,
 &#39;tcp://127.0.0.1:45134&#39;: None,
 &#39;tcp://127.0.0.1:45442&#39;: None,
 &#39;tcp://127.0.0.1:46068&#39;: None}
</pre></div></div>
</div>
</div>
<div class="section" id="Define-NVTabular-dataset">
<h3>Define NVTabular dataset<a class="headerlink" href="#Define-NVTabular-dataset" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>train_paths = glob.glob(&#39;./data/train.parquet&#39;)
valid_paths = glob.glob(&#39;./data/valid.parquet&#39;)
test_paths = glob.glob(&#39;./data/test.parquet&#39;)

train_dataset = nvt.Dataset(train_paths, engine=&#39;parquet&#39;, part_mem_fraction=0.15)
valid_dataset = nvt.Dataset(valid_paths, engine=&#39;parquet&#39;, part_mem_fraction=0.15)
test_dataset = nvt.Dataset(test_paths, engine=&#39;parquet&#39;, part_mem_fraction=0.15)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>train_dataset.to_ddf().head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_time</th>
      <th>event_type</th>
      <th>product_id</th>
      <th>brand</th>
      <th>price</th>
      <th>user_id</th>
      <th>user_session</th>
      <th>target</th>
      <th>cat_0</th>
      <th>cat_1</th>
      <th>cat_2</th>
      <th>cat_3</th>
      <th>timestamp</th>
      <th>ts_hour</th>
      <th>ts_minute</th>
      <th>ts_weekday</th>
      <th>ts_day</th>
      <th>ts_month</th>
      <th>ts_year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2020-02-01 00:00:18 UTC</td>
      <td>cart</td>
      <td>100065078</td>
      <td>xiaomi</td>
      <td>568.61</td>
      <td>526615078</td>
      <td>5f0aab9f-f92e-4eff-b0d2-fcec5f553f01</td>
      <td>0</td>
      <td>construction</td>
      <td>tools</td>
      <td>light</td>
      <td>&lt;NA&gt;</td>
      <td>2020-02-01 00:00:18</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2020</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2020-02-01 00:00:18 UTC</td>
      <td>cart</td>
      <td>5701246</td>
      <td>&lt;NA&gt;</td>
      <td>24.43</td>
      <td>563902689</td>
      <td>76cc9152-8a9f-43e9-b98a-ee484510f379</td>
      <td>0</td>
      <td>electronics</td>
      <td>video</td>
      <td>tv</td>
      <td>&lt;NA&gt;</td>
      <td>2020-02-01 00:00:18</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2020</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2020-02-01 00:00:31 UTC</td>
      <td>cart</td>
      <td>14701533</td>
      <td>&lt;NA&gt;</td>
      <td>154.42</td>
      <td>520953435</td>
      <td>5f1c7752-cf92-41fc-9a16-e8897a90eee8</td>
      <td>0</td>
      <td>electronics</td>
      <td>video</td>
      <td>projector</td>
      <td>&lt;NA&gt;</td>
      <td>2020-02-01 00:00:31</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2020</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2020-02-01 00:00:40 UTC</td>
      <td>cart</td>
      <td>1004855</td>
      <td>xiaomi</td>
      <td>123.30</td>
      <td>519236281</td>
      <td>e512f514-dc7f-4fc9-9042-e3955989d395</td>
      <td>0</td>
      <td>construction</td>
      <td>tools</td>
      <td>light</td>
      <td>&lt;NA&gt;</td>
      <td>2020-02-01 00:00:40</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2020</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2020-02-01 00:00:47 UTC</td>
      <td>cart</td>
      <td>1005100</td>
      <td>samsung</td>
      <td>140.28</td>
      <td>550305600</td>
      <td>bd7a37b6-420d-4575-8852-ac825aff39b5</td>
      <td>0</td>
      <td>construction</td>
      <td>tools</td>
      <td>light</td>
      <td>&lt;NA&gt;</td>
      <td>2020-02-01 00:00:47</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2020</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>len(train_dataset.to_ddf().columns)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
19
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>train_dataset.to_ddf().columns
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Index([&#39;event_time&#39;, &#39;event_type&#39;, &#39;product_id&#39;, &#39;brand&#39;, &#39;price&#39;, &#39;user_id&#39;,
       &#39;user_session&#39;, &#39;target&#39;, &#39;cat_0&#39;, &#39;cat_1&#39;, &#39;cat_2&#39;, &#39;cat_3&#39;,
       &#39;timestamp&#39;, &#39;ts_hour&#39;, &#39;ts_minute&#39;, &#39;ts_weekday&#39;, &#39;ts_day&#39;, &#39;ts_month&#39;,
       &#39;ts_year&#39;],
      dtype=&#39;object&#39;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>len(train_dataset.to_ddf())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
7949839
</pre></div></div>
</div>
</div>
<div class="section" id="Preprocessing-and-feature-engineering">
<h3>Preprocessing and feature engineering<a class="headerlink" href="#Preprocessing-and-feature-engineering" title="Permalink to this headline"></a></h3>
<p>In this notebook we will explore a few feature engineering technique with NVTabular:</p>
<ul class="simple">
<li><p>Creating cross features, e.g. <code class="docutils literal notranslate"><span class="pre">user_id</span></code> and <code class="docutils literal notranslate"><span class="pre">'brand</span></code></p></li>
<li><p>Target encoding</p></li>
</ul>
<p>The engineered features will then be preprocessed into a form suitable for machine learning model:</p>
<ul class="simple">
<li><p>Fill missing values</p></li>
<li><p>Encoding categorical features into integer values</p></li>
<li><p>Normalization of numeric features</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from nvtabular.ops import LambdaOp

# cross features
def user_id_cross_maker(col, gdf):
    return col.astype(str) + &#39;_&#39; + gdf[&#39;user_id&#39;].astype(str)

user_id_cross_features = (
    nvt.ColumnGroup([&#39;product_id&#39;, &#39;brand&#39;, &#39;ts_hour&#39;, &#39;ts_minute&#39;]) &gt;&gt;
    LambdaOp(user_id_cross_maker, dependency=[&#39;user_id&#39;]) &gt;&gt;
    nvt.ops.Rename(postfix = &#39;_user_id_cross&#39;)
)


def user_id_brand_cross_maker(col, gdf):
    return col.astype(str) + &#39;_&#39; + gdf[&#39;user_id&#39;].astype(str) + &#39;_&#39; + gdf[&#39;brand&#39;].astype(str)

user_id_brand_cross_features = (
    nvt.ColumnGroup([&#39;ts_hour&#39;, &#39;ts_weekday&#39;, &#39;cat_0&#39;, &#39;cat_1&#39;, &#39;cat_2&#39;]) &gt;&gt;
    LambdaOp(user_id_brand_cross_maker, dependency=[&#39;user_id&#39;, &#39;brand&#39;]) &gt;&gt;
    nvt.ops.Rename(postfix = &#39;_user_id_brand_cross&#39;)
)

target_encode = (
    [&#39;brand&#39;, &#39;user_id&#39;, &#39;product_id&#39;, &#39;cat_2&#39;, [&#39;ts_weekday&#39;, &#39;ts_day&#39;]] &gt;&gt;
    nvt.ops.TargetEncoding(
        nvt.ColumnGroup(&#39;target&#39;),
        kfold=5,
        p_smooth=20,
        out_dtype=&quot;float32&quot;,
        )
)

cat_feats = (user_id_brand_cross_features + user_id_cross_features) &gt;&gt; nvt.ops.Categorify()
cont_feats =  [&#39;price&#39;, &#39;ts_weekday&#39;, &#39;ts_day&#39;, &#39;ts_month&#39;] &gt;&gt; nvt.ops.FillMissing() &gt;&gt;  nvt.ops.Normalize()
cont_feats += target_encode &gt;&gt; nvt.ops.Rename(postfix = &#39;_TE&#39;)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>output = cat_feats + cont_feats + &#39;target&#39;
proc = nvt.Workflow(output)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/nvtabular/nvtabular/workflow/workflow.py:89: UserWarning: A global dask.distributed client has been detected, but the single-threaded scheduler will be used for execution. Please use the `client` argument to initialize a `Workflow` object with distributed-execution enabled.
  warnings.warn(
</pre></div></div>
</div>
</div>
<div class="section" id="Visualize-workflow-as-a-DAG">
<h3>Visualize workflow as a DAG<a class="headerlink" href="#Visualize-workflow-as-a-DAG" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!apt install -y graphviz
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>output.graph
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_ecommerce-example_35_0.svg" src="../_images/notebooks_ecommerce-example_35_0.svg" /></div>
</div>
</div>
<div class="section" id="Executing-the-workflow">
<h3>Executing the workflow<a class="headerlink" href="#Executing-the-workflow" title="Permalink to this headline"></a></h3>
<p>After having defined the workflow, calling the <code class="docutils literal notranslate"><span class="pre">fit()</span></code> method will start the actual computation to record the required statistics from the training data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
time_preproc_start = time()
proc.fit(train_dataset)
time_preproc = time()-time_preproc_start
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/usr/local/lib/python3.8/dist-packages/numba/cuda/compiler.py:865: NumbaPerformanceWarning: Grid size (1) &lt; 2 * SM count (112) will likely result in GPU under utilization due to low occupancy.
  warn(NumbaPerformanceWarning(msg))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 13.3 s, sys: 10.1 s, total: 23.4 s
Wall time: 26.8 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cat_feats.output_columns.names
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;ts_hour_user_id_brand_cross&#39;,
 &#39;ts_weekday_user_id_brand_cross&#39;,
 &#39;cat_0_user_id_brand_cross&#39;,
 &#39;cat_1_user_id_brand_cross&#39;,
 &#39;cat_2_user_id_brand_cross&#39;,
 &#39;product_id_user_id_cross&#39;,
 &#39;brand_user_id_cross&#39;,
 &#39;ts_hour_user_id_cross&#39;,
 &#39;ts_minute_user_id_cross&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>output.output_columns.names
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;ts_hour_user_id_brand_cross&#39;,
 &#39;ts_weekday_user_id_brand_cross&#39;,
 &#39;cat_0_user_id_brand_cross&#39;,
 &#39;cat_1_user_id_brand_cross&#39;,
 &#39;cat_2_user_id_brand_cross&#39;,
 &#39;product_id_user_id_cross&#39;,
 &#39;brand_user_id_cross&#39;,
 &#39;ts_hour_user_id_cross&#39;,
 &#39;ts_minute_user_id_cross&#39;,
 &#39;price&#39;,
 &#39;ts_weekday&#39;,
 &#39;ts_day&#39;,
 &#39;ts_month&#39;,
 &#39;TE_brand_target_TE&#39;,
 &#39;TE_user_id_target_TE&#39;,
 &#39;TE_product_id_target_TE&#39;,
 &#39;TE_cat_2_target_TE&#39;,
 &#39;TE_ts_weekday_ts_day_target_TE&#39;,
 &#39;target&#39;]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>CAT_FEATS = [&#39;ts_hour_user_id_brand_cross&#39;,
 &#39;ts_weekday_user_id_brand_cross&#39;,
 &#39;cat_0_user_id_brand_cross&#39;,
 &#39;cat_1_user_id_brand_cross&#39;,
 &#39;cat_2_user_id_brand_cross&#39;,
 &#39;product_id_user_id_cross&#39;,
 &#39;brand_user_id_cross&#39;,
 &#39;ts_hour_user_id_cross&#39;,
 &#39;ts_minute_user_id_cross&#39;,]

CON_FEATS = [&#39;price&#39;,
 &#39;ts_weekday&#39;,
 &#39;ts_day&#39;,
 &#39;ts_month&#39;,
 &#39;TE_brand_target_TE&#39;,
 &#39;TE_user_id_target_TE&#39;,
 &#39;TE_product_id_target_TE&#39;,
 &#39;TE_cat_2_target_TE&#39;,
 &#39;TE_ts_weekday_ts_day_target_TE&#39;]

dict_dtypes = {}
for col in CAT_FEATS:
    dict_dtypes[col] = np.int64
for col in CON_FEATS:
    dict_dtypes[col] = np.float32

dict_dtypes[&#39;target&#39;] = np.float32
</pre></div>
</div>
</div>
<p>Next, we call the <code class="docutils literal notranslate"><span class="pre">transform()</span></code> method to transform the datasets.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>output_train_dir = os.path.join(output_path, &#39;train/&#39;)
output_valid_dir = os.path.join(output_path, &#39;valid/&#39;)
output_test_dir = os.path.join(output_path, &#39;test/&#39;)
! rm -rf $output_train_dir &amp;&amp; mkdir -p $output_train_dir
! rm -rf $output_valid_dir &amp;&amp; mkdir -p $output_valid_dir
! rm -rf $output_test_dir &amp;&amp; mkdir -p $output_test_dir
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

time_preproc_start = time()
proc.transform(train_dataset).to_parquet(output_path=output_train_dir, dtypes=dict_dtypes,
                                         shuffle=nvt.io.Shuffle.PER_PARTITION,
                                         cats=CAT_FEATS,
                                         conts=CON_FEATS,
                                         labels=[&#39;target&#39;])
time_preproc += time()-time_preproc_start
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/nvtabular/nvtabular/io/dask.py:375: UserWarning: A global dask.distributed client has been detected, but the single-threaded scheduler will be used for this write operation. Please use the `client` argument to initialize a `Dataset` and/or `Workflow` object with distributed-execution enabled.
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.6 s, sys: 3.29 s, total: 4.89 s
Wall time: 5.79 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!ls -l $output_train_dir
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
total 366131
-rw-r--r-- 1 root dip        47 Nov 16 23:04 _file_list.txt
-rw-r--r-- 1 root dip     18283 Nov 16 23:04 _metadata
-rw-r--r-- 1 root dip      1045 Nov 16 23:04 _metadata.json
-rw-r--r-- 1 root dip 706364298 Nov 16 23:04 part_0.parquet
-rw-r--r-- 1 root dip      7975 Nov 16 23:04 schema.pbtxt
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

time_preproc_start = time()
proc.transform(valid_dataset).to_parquet(output_path=output_valid_dir, dtypes=dict_dtypes,
                                         shuffle=nvt.io.Shuffle.PER_PARTITION,
                                         cats=CAT_FEATS,
                                         conts=CON_FEATS,
                                         labels=[&#39;target&#39;])
time_preproc += time()-time_preproc_start
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.06 s, sys: 1.57 s, total: 2.63 s
Wall time: 2.83 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!ls -l $output_valid_dir
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
total 100979
-rw-r--r-- 1 root dip       47 Nov 16 23:04 _file_list.txt
-rw-r--r-- 1 root dip     8983 Nov 16 23:04 _metadata
-rw-r--r-- 1 root dip     1045 Nov 16 23:04 _metadata.json
-rw-r--r-- 1 root dip 92826604 Nov 16 23:04 part_0.parquet
-rw-r--r-- 1 root dip     7975 Nov 16 23:04 schema.pbtxt
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

time_preproc_start = time()
proc.transform(test_dataset).to_parquet(output_path=output_test_dir, dtypes=dict_dtypes,
                                         shuffle=nvt.io.Shuffle.PER_PARTITION,
                                         cats=CAT_FEATS,
                                         conts=CON_FEATS,
                                         labels=[&#39;target&#39;])
time_preproc += time()-time_preproc_start
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.05 s, sys: 1.64 s, total: 2.69 s
Wall time: 2.75 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>time_preproc
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
38.198790550231934
</pre></div></div>
</div>
</div>
<div class="section" id="Verify-the-preprocessed-data">
<h3>Verify the preprocessed data<a class="headerlink" href="#Verify-the-preprocessed-data" title="Permalink to this headline"></a></h3>
<p>Let’s quickly read the data back and verify that all fields have the expected format.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!ls $output_train_dir
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
_file_list.txt  _metadata  _metadata.json  part_0.parquet  schema.pbtxt
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>nvtdata = pd.read_parquet(output_train_dir+&#39;/part_0.parquet&#39;)
nvtdata.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ts_hour_user_id_brand_cross</th>
      <th>ts_weekday_user_id_brand_cross</th>
      <th>cat_0_user_id_brand_cross</th>
      <th>cat_1_user_id_brand_cross</th>
      <th>cat_2_user_id_brand_cross</th>
      <th>product_id_user_id_cross</th>
      <th>brand_user_id_cross</th>
      <th>ts_hour_user_id_cross</th>
      <th>ts_minute_user_id_cross</th>
      <th>price</th>
      <th>ts_weekday</th>
      <th>ts_day</th>
      <th>ts_month</th>
      <th>TE_brand_target_TE</th>
      <th>TE_user_id_target_TE</th>
      <th>TE_product_id_target_TE</th>
      <th>TE_cat_2_target_TE</th>
      <th>TE_ts_weekday_ts_day_target_TE</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>817883</td>
      <td>908980</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1085846</td>
      <td>855303</td>
      <td>144463</td>
      <td>5417827</td>
      <td>-0.725652</td>
      <td>-0.502085</td>
      <td>0.235441</td>
      <td>1.314784</td>
      <td>0.199788</td>
      <td>0.325234</td>
      <td>0.227236</td>
      <td>-1.284867</td>
      <td>0.387063</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4152058</td>
      <td>2732403</td>
      <td>1210052</td>
      <td>712779</td>
      <td>0</td>
      <td>1360101</td>
      <td>954962</td>
      <td>731363</td>
      <td>2230166</td>
      <td>-0.836849</td>
      <td>-0.007929</td>
      <td>-0.802043</td>
      <td>-0.864342</td>
      <td>0.355313</td>
      <td>0.266837</td>
      <td>0.255486</td>
      <td>-1.285741</td>
      <td>0.420646</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3204608</td>
      <td>274365</td>
      <td>30730</td>
      <td>31144</td>
      <td>25505</td>
      <td>29457</td>
      <td>32720</td>
      <td>3039842</td>
      <td>3062261</td>
      <td>-0.184922</td>
      <td>-0.007929</td>
      <td>1.618752</td>
      <td>-0.864342</td>
      <td>0.466206</td>
      <td>0.237990</td>
      <td>0.414308</td>
      <td>0.459563</td>
      <td>0.239809</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3464677</td>
      <td>0</td>
      <td>2467278</td>
      <td>2493129</td>
      <td>-0.841169</td>
      <td>-0.007929</td>
      <td>0.465993</td>
      <td>-0.666240</td>
      <td>-1.285569</td>
      <td>0.390281</td>
      <td>0.318047</td>
      <td>-1.288352</td>
      <td>0.376334</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2665639</td>
      <td>66327</td>
      <td>19261</td>
      <td>19397</td>
      <td>16204</td>
      <td>2497109</td>
      <td>16447</td>
      <td>2620458</td>
      <td>2349810</td>
      <td>3.510283</td>
      <td>0.486228</td>
      <td>0.581269</td>
      <td>-0.666240</td>
      <td>0.446405</td>
      <td>0.533477</td>
      <td>0.492186</td>
      <td>0.459563</td>
      <td>0.388496</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!ls $output_valid_dir
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
_file_list.txt  _metadata  _metadata.json  part_0.parquet  schema.pbtxt
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>nvtdata_valid = pd.read_parquet(output_valid_dir+&#39;/part_0.parquet&#39;)
nvtdata_valid.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ts_hour_user_id_brand_cross</th>
      <th>ts_weekday_user_id_brand_cross</th>
      <th>cat_0_user_id_brand_cross</th>
      <th>cat_1_user_id_brand_cross</th>
      <th>cat_2_user_id_brand_cross</th>
      <th>product_id_user_id_cross</th>
      <th>brand_user_id_cross</th>
      <th>ts_hour_user_id_cross</th>
      <th>ts_minute_user_id_cross</th>
      <th>price</th>
      <th>ts_weekday</th>
      <th>ts_day</th>
      <th>ts_month</th>
      <th>TE_brand_target_TE</th>
      <th>TE_user_id_target_TE</th>
      <th>TE_product_id_target_TE</th>
      <th>TE_cat_2_target_TE</th>
      <th>TE_ts_weekday_ts_day_target_TE</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1.107537</td>
      <td>0.980384</td>
      <td>-0.225663</td>
      <td>-0.468138</td>
      <td>0.372078</td>
      <td>0.390281</td>
      <td>0.427259</td>
      <td>0.390176</td>
      <td>0.353950</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>-0.840005</td>
      <td>0.980384</td>
      <td>-0.225663</td>
      <td>-0.468138</td>
      <td>0.364968</td>
      <td>0.390281</td>
      <td>0.320797</td>
      <td>-1.284867</td>
      <td>0.352739</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>-0.327548</td>
      <td>-1.490397</td>
      <td>-0.802043</td>
      <td>-0.468138</td>
      <td>0.466705</td>
      <td>0.390281</td>
      <td>0.498779</td>
      <td>0.459734</td>
      <td>0.380590</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2.291189</td>
      <td>-1.490397</td>
      <td>-1.608975</td>
      <td>-0.468138</td>
      <td>0.446405</td>
      <td>0.390281</td>
      <td>0.303992</td>
      <td>0.459563</td>
      <td>0.408594</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>0</td>
      <td>2677742</td>
      <td>1812225</td>
      <td>1033276</td>
      <td>3759307</td>
      <td>2828489</td>
      <td>0</td>
      <td>0</td>
      <td>-0.738273</td>
      <td>-0.007929</td>
      <td>1.157649</td>
      <td>-0.468138</td>
      <td>0.277334</td>
      <td>0.390281</td>
      <td>0.326134</td>
      <td>0.257637</td>
      <td>0.409076</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sum(nvtdata_valid[&#39;ts_hour_user_id_brand_cross&#39;]==0)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2359020
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>len(nvtdata_valid)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2461719
</pre></div></div>
</div>
</div>
<div class="section" id="Getting-the-embedding-size">
<h3>Getting the embedding size<a class="headerlink" href="#Getting-the-embedding-size" title="Permalink to this headline"></a></h3>
<p>Next, we need to get the embedding size for the categorical variables. This is an important input for defining the embedding table size to be used by HugeCTR.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>embeddings = ops.get_embedding_sizes(proc)
embeddings
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;ts_hour_user_id_brand_cross&#39;: (4427037, 512),
 &#39;ts_weekday_user_id_brand_cross&#39;: (3961156, 512),
 &#39;cat_0_user_id_brand_cross&#39;: (2877223, 512),
 &#39;cat_1_user_id_brand_cross&#39;: (2890639, 512),
 &#39;cat_2_user_id_brand_cross&#39;: (2159304, 512),
 &#39;product_id_user_id_cross&#39;: (4398425, 512),
 &#39;brand_user_id_cross&#39;: (3009092, 512),
 &#39;ts_hour_user_id_cross&#39;: (3999369, 512),
 &#39;ts_minute_user_id_cross&#39;: (5931061, 512)}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print([embeddings[x][0] for x in cat_feats.output_columns.names])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[4427037, 3961156, 2877223, 2890639, 2159304, 4398425, 3009092, 3999369, 5931061]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cat_feats.output_columns.names
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;ts_hour_user_id_brand_cross&#39;,
 &#39;ts_weekday_user_id_brand_cross&#39;,
 &#39;cat_0_user_id_brand_cross&#39;,
 &#39;cat_1_user_id_brand_cross&#39;,
 &#39;cat_2_user_id_brand_cross&#39;,
 &#39;product_id_user_id_cross&#39;,
 &#39;brand_user_id_cross&#39;,
 &#39;ts_hour_user_id_cross&#39;,
 &#39;ts_minute_user_id_cross&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>embedding_size_str = &quot;{}&quot;.format([embeddings[x][0] for x in cat_feats.output_columns.names])
embedding_size_str
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;[4427037, 3961156, 2877223, 2890639, 2159304, 4398425, 3009092, 3999369, 5931061]&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>num_con_feates = len(CON_FEATS)
num_con_feates
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
9
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print([embeddings[x][0] for x in cat_feats.output_columns.names])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[4427037, 3961156, 2877223, 2890639, 2159304, 4398425, 3009092, 3999369, 5931061]
</pre></div></div>
</div>
<p>Next, we’ll shutdown our Dask client from earlier to free up some memory so that we can share it with HugeCTR.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>client.shutdown()
cluster.close()
</pre></div>
</div>
</div>
</div>
<div class="section" id="Preparing-the-training-Python-script-for-HugeCTR">
<h3>Preparing the training Python script for HugeCTR<a class="headerlink" href="#Preparing-the-training-Python-script-for-HugeCTR" title="Permalink to this headline"></a></h3>
<p>HugeCTR model can be defined by Python API. The below Python script defines a DLRM model and specifies the training resources.</p>
<p>Several parameters that need to be edited to match this dataset are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">slot_size_array</span></code>: cadinalities for the categorical variables</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dense_dim</span></code>: number of dense features</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">slot_num</span></code>: number of categorical variables</p></li>
</ul>
<p>The model graph can be saved into a JSON file by calling <code class="docutils literal notranslate"><span class="pre">model.graph_to_json</span></code>, which will be used for inference afterwards.</p>
<p>In the below we will traing the network using 8 GPUs, and a workspace of 4000MB per GPU. Note that the total embedding size is 33653306<em>128</em>4/(1024**3) = 16.432GB</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%writefile hugectr_dlrm_ecommerce.py
import hugectr
from mpi4py import MPI
solver = hugectr.CreateSolver(max_eval_batches = 2720,
                              batchsize_eval = 16384,
                              batchsize = 16384,
                              lr = 0.1,
                              warmup_steps = 8000,
                              decay_start = 48000,
                              decay_steps = 24000,
                              vvgpu = [[0,1,2,3,4,5,6,7]],
                              repeat_dataset = True,
                              i64_input_key = True)
reader = hugectr.DataReaderParams(data_reader_type = hugectr.DataReaderType_t.Parquet,
                                  source = [&quot;./nvtabular_temp/output/train/_file_list.txt&quot;],
                                  eval_source = &quot;./nvtabular_temp/output/valid/_file_list.txt&quot;,
                                  check_type = hugectr.Check_t.Non,
                                  slot_size_array = [4427037, 3961156, 2877223, 2890639, 2159304, 4398425, 3009092, 3999369, 5931061])
optimizer = hugectr.CreateOptimizer(optimizer_type = hugectr.Optimizer_t.SGD,
                                    update_type = hugectr.Update_t.Local,
                                    atomic_update = True)
model = hugectr.Model(solver, reader, optimizer)
model.add(hugectr.Input(label_dim = 1, label_name = &quot;label&quot;,
                        dense_dim = 9, dense_name = &quot;dense&quot;,
                        data_reader_sparse_param_array =
                        [hugectr.DataReaderSparseParam(&quot;data1&quot;, 1, True, 9)]))
model.add(hugectr.SparseEmbedding(embedding_type = hugectr.Embedding_t.DistributedSlotSparseEmbeddingHash,
                            workspace_size_per_gpu_in_mb = 4000,
                            embedding_vec_size = 128,
                            combiner = &#39;sum&#39;,
                            sparse_embedding_name = &quot;sparse_embedding1&quot;,
                            bottom_name = &quot;data1&quot;,
                            optimizer = optimizer))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.InnerProduct,
                            bottom_names = [&quot;dense&quot;],
                            top_names = [&quot;fc1&quot;],
                            num_output=512))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.ReLU,
                            bottom_names = [&quot;fc1&quot;],
                            top_names = [&quot;relu1&quot;]))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.InnerProduct,
                            bottom_names = [&quot;relu1&quot;],
                            top_names = [&quot;fc2&quot;],
                            num_output=256))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.ReLU,
                            bottom_names = [&quot;fc2&quot;],
                            top_names = [&quot;relu2&quot;]))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.InnerProduct,
                            bottom_names = [&quot;relu2&quot;],
                            top_names = [&quot;fc3&quot;],
                            num_output=128))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.ReLU,
                            bottom_names = [&quot;fc3&quot;],
                            top_names = [&quot;relu3&quot;]))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.Interaction,
                            bottom_names = [&quot;relu3&quot;,&quot;sparse_embedding1&quot;],
                            top_names = [&quot;interaction1&quot;]))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.InnerProduct,
                            bottom_names = [&quot;interaction1&quot;],
                            top_names = [&quot;fc4&quot;],
                            num_output=1024))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.ReLU,
                            bottom_names = [&quot;fc4&quot;],
                            top_names = [&quot;relu4&quot;]))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.InnerProduct,
                            bottom_names = [&quot;relu4&quot;],
                            top_names = [&quot;fc5&quot;],
                            num_output=1024))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.ReLU,
                            bottom_names = [&quot;fc5&quot;],
                            top_names = [&quot;relu5&quot;]))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.InnerProduct,
                            bottom_names = [&quot;relu5&quot;],
                            top_names = [&quot;fc6&quot;],
                            num_output=512))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.ReLU,
                            bottom_names = [&quot;fc6&quot;],
                            top_names = [&quot;relu6&quot;]))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.InnerProduct,
                            bottom_names = [&quot;relu6&quot;],
                            top_names = [&quot;fc7&quot;],
                            num_output=256))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.ReLU,
                            bottom_names = [&quot;fc7&quot;],
                            top_names = [&quot;relu7&quot;]))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.InnerProduct,
                            bottom_names = [&quot;relu7&quot;],
                            top_names = [&quot;fc8&quot;],
                            num_output=1))
model.add(hugectr.DenseLayer(layer_type = hugectr.Layer_t.BinaryCrossEntropyLoss,
                            bottom_names = [&quot;fc8&quot;, &quot;label&quot;],
                            top_names = [&quot;loss&quot;]))
model.compile()
model.summary()
model.graph_to_json(graph_config_file = &quot;dlrm_ecommerce.json&quot;)
model.fit(max_iter = 12000, display = 1000, eval_interval = 3000, snapshot = 10000, snapshot_prefix = &quot;./&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Overwriting hugectr_dlrm_ecommerce.py
</pre></div></div>
</div>
<p>## 3. HugeCTR training</p>
<p>Now we are ready to train a DLRM model with HugeCTR.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!python3 hugectr_dlrm_ecommerce.py
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
HugeCTR Version: 3.2
====================================================Model Init=====================================================
[HUGECTR][23:17:45][INFO][RANK0]: Global seed is 1985961998
[HUGECTR][23:17:45][INFO][RANK0]: Device to NUMA mapping:
  GPU 0 -&gt;  node 0
  GPU 1 -&gt;  node 0
  GPU 2 -&gt;  node 0
  GPU 3 -&gt;  node 0
  GPU 4 -&gt;  node 1
  GPU 5 -&gt;  node 1
  GPU 6 -&gt;  node 1
  GPU 7 -&gt;  node 1

[HUGECTR][23:17:54][WARNING][RANK0]: Peer-to-peer access cannot be fully enabled.
[HUGECTR][23:17:54][INFO][RANK0]: Start all2all warmup
[HUGECTR][23:17:54][INFO][RANK0]: End all2all warmup
[HUGECTR][23:17:54][INFO][RANK0]: Using All-reduce algorithm: NCCL
[HUGECTR][23:17:54][INFO][RANK0]: Device 0: Tesla P100-SXM2-16GB
[HUGECTR][23:17:54][INFO][RANK0]: Device 1: Tesla P100-SXM2-16GB
[HUGECTR][23:17:54][INFO][RANK0]: Device 2: Tesla P100-SXM2-16GB
[HUGECTR][23:17:54][INFO][RANK0]: Device 3: Tesla P100-SXM2-16GB
[HUGECTR][23:17:54][INFO][RANK0]: Device 4: Tesla P100-SXM2-16GB
[HUGECTR][23:17:54][INFO][RANK0]: Device 5: Tesla P100-SXM2-16GB
[HUGECTR][23:17:54][INFO][RANK0]: Device 6: Tesla P100-SXM2-16GB
[HUGECTR][23:17:54][INFO][RANK0]: Device 7: Tesla P100-SXM2-16GB
[HUGECTR][23:17:54][INFO][RANK0]: num of DataReader workers: 8
[HUGECTR][23:17:55][INFO][RANK0]: Vocabulary size: 33653306
[HUGECTR][23:17:55][INFO][RANK0]: max_vocabulary_size_per_gpu_=8192000
[HUGECTR][23:17:58][INFO][RANK0]: Graph analysis to resolve tensor dependency
===================================================Model Compile===================================================
[HUGECTR][23:18:12][INFO][RANK0]: gpu0 start to init embedding
[HUGECTR][23:18:12][INFO][RANK0]: gpu1 start to init embedding
[HUGECTR][23:18:12][INFO][RANK0]: gpu6 start to init embedding
[HUGECTR][23:18:12][INFO][RANK0]: gpu2 start to init embedding
[HUGECTR][23:18:12][INFO][RANK0]: gpu7 start to init embedding
[HUGECTR][23:18:12][INFO][RANK0]: gpu5 start to init embedding
[HUGECTR][23:18:12][INFO][RANK0]: gpu3 start to init embedding
[HUGECTR][23:18:12][INFO][RANK0]: gpu4 start to init embedding
[HUGECTR][23:18:12][INFO][RANK0]: gpu0 init embedding done
[HUGECTR][23:18:12][INFO][RANK0]: gpu1 init embedding done
[HUGECTR][23:18:12][INFO][RANK0]: gpu2 init embedding done
[HUGECTR][23:18:12][INFO][RANK0]: gpu7 init embedding done
[HUGECTR][23:18:12][INFO][RANK0]: gpu6 init embedding done
[HUGECTR][23:18:12][INFO][RANK0]: gpu5 init embedding done
[HUGECTR][23:18:12][INFO][RANK0]: gpu4 init embedding done
[HUGECTR][23:18:12][INFO][RANK0]: gpu3 init embedding done
[HUGECTR][23:18:12][INFO][RANK0]: Starting AUC NCCL warm-up
[HUGECTR][23:18:12][INFO][RANK0]: Warm-up done
===================================================Model Summary===================================================
label                                   Dense                         Sparse
label                                   dense                          data1
(None, 1)                               (None, 9)
------------------------------------------------------------------------------------------------------------------
Layer Type                              Input Name                    Output Name                   Output Shape
------------------------------------------------------------------------------------------------------------------
DistributedSlotSparseEmbeddingHash      data1                         sparse_embedding1             (None, 9, 128)
InnerProduct                            dense                         fc1                           (None, 512)
ReLU                                    fc1                           relu1                         (None, 512)
InnerProduct                            relu1                         fc2                           (None, 256)
ReLU                                    fc2                           relu2                         (None, 256)
InnerProduct                            relu2                         fc3                           (None, 128)
ReLU                                    fc3                           relu3                         (None, 128)
Interaction                             relu3,sparse_embedding1       interaction1                  (None, 174)
InnerProduct                            interaction1                  fc4                           (None, 1024)
ReLU                                    fc4                           relu4                         (None, 1024)
InnerProduct                            relu4                         fc5                           (None, 1024)
ReLU                                    fc5                           relu5                         (None, 1024)
InnerProduct                            relu5                         fc6                           (None, 512)
ReLU                                    fc6                           relu6                         (None, 512)
InnerProduct                            relu6                         fc7                           (None, 256)
ReLU                                    fc7                           relu7                         (None, 256)
InnerProduct                            relu7                         fc8                           (None, 1)
BinaryCrossEntropyLoss                  fc8,label                     loss
------------------------------------------------------------------------------------------------------------------
[HUGECTR][23:18:12][INFO][RANK0]: Save the model graph to dlrm_ecommerce.json successfully
=====================================================Model Fit=====================================================
[HUGECTR][23:18:12][INFO][RANK0]: Use non-epoch mode with number of iterations: 12000
[HUGECTR][23:18:12][INFO][RANK0]: Training batchsize: 16384, evaluation batchsize: 16384
[HUGECTR][23:18:12][INFO][RANK0]: Evaluation interval: 3000, snapshot interval: 10000
[HUGECTR][23:18:12][INFO][RANK0]: Sparse embedding trainable: 1, dense network trainable: 1
[HUGECTR][23:18:12][INFO][RANK0]: Use mixed precision: 0, scaler: 1, use cuda graph: -875196854
[HUGECTR][23:18:12][INFO][RANK0]: lr: 0.100000, warmup_steps: 8000, decay_start: 48000, decay_steps: 24000, decay_power: 2.000000, end_lr: 0.000000
[HUGECTR][23:18:12][INFO][RANK0]: Training source file: ./nvtabular_temp/output/train/_file_list.txt
[HUGECTR][23:18:12][INFO][RANK0]: Evaluation source file: ./nvtabular_temp/output/valid/_file_list.txt
[HUGECTR][23:18:20][INFO][RANK0]: Iter: 1000 Time(1000 iters): 8.477706s Loss: 0.654302 lr:0.012512
[HUGECTR][23:18:29][INFO][RANK0]: Iter: 2000 Time(1000 iters): 8.461642s Loss: 0.537260 lr:0.025013
[HUGECTR][23:18:37][INFO][RANK0]: Iter: 3000 Time(1000 iters): 8.473848s Loss: 0.523659 lr:0.037512
[HUGECTR][23:18:47][INFO][RANK0]: Evaluation, AUC: 0.652278
[HUGECTR][23:18:47][INFO][RANK0]: Eval Time for 2720 iters: 9.794543s
[HUGECTR][23:18:56][INFO][RANK0]: Iter: 4000 Time(1000 iters): 18.361339s Loss: 0.521578 lr:0.050012
[HUGECTR][23:19:04][INFO][RANK0]: Iter: 5000 Time(1000 iters): 8.492043s Loss: 0.515692 lr:0.062513
[HUGECTR][23:19:13][INFO][RANK0]: Iter: 6000 Time(1000 iters): 8.491605s Loss: 0.518826 lr:0.075013
[HUGECTR][23:19:22][INFO][RANK0]: Evaluation, AUC: 0.650539
[HUGECTR][23:19:22][INFO][RANK0]: Eval Time for 2720 iters: 9.814989s
[HUGECTR][23:19:31][INFO][RANK0]: Iter: 7000 Time(1000 iters): 18.332924s Loss: 0.511855 lr:0.087513
[HUGECTR][23:19:39][INFO][RANK0]: Iter: 8000 Time(1000 iters): 8.488666s Loss: 0.515189 lr:0.100000
[HUGECTR][23:19:48][INFO][RANK0]: Iter: 9000 Time(1000 iters): 8.455840s Loss: 0.513654 lr:0.100000
[HUGECTR][23:19:58][INFO][RANK0]: Evaluation, AUC: 0.645823
[HUGECTR][23:19:58][INFO][RANK0]: Eval Time for 2720 iters: 9.750920s
[HUGECTR][23:20:06][INFO][RANK0]: Iter: 10000 Time(1000 iters): 18.285750s Loss: 0.518827 lr:0.100000
[HUGECTR][23:20:15][INFO][RANK0]: Rank0: Write hash table to file
[HUGECTR][23:21:26][INFO][RANK0]: Dumping sparse weights to files, successful
[HUGECTR][23:21:26][INFO][RANK0]: Dumping sparse optimzer states to files, successful
[HUGECTR][23:21:26][INFO][RANK0]: Dumping dense weights to file, successful
[HUGECTR][23:21:26][INFO][RANK0]: Dumping dense optimizer states to file, successful
[HUGECTR][23:21:26][INFO][RANK0]: Dumping untrainable weights to file, successful
[HUGECTR][23:21:35][INFO][RANK0]: Iter: 11000 Time(1000 iters): 88.781702s Loss: 0.511783 lr:0.100000
[HUGECTR][23:21:43][INFO][RANK0]: Finish 12000 iterations with batchsize: 16384 in 211.67s.
</pre></div></div>
</div>
<p>## 4. HugeCTR inference</p>
<p>In this section, we will read the test dataset, and compute the AUC value.</p>
<p>We will utilize the saved model graph in JSON format for inference.</p>
</div>
<div class="section" id="Prepare-the-inference-session">
<h3>Prepare the inference session<a class="headerlink" href="#Prepare-the-inference-session" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import sys
from hugectr.inference import InferenceParams, CreateInferenceSession
from mpi4py import MPI
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># create inference session
inference_params = InferenceParams(model_name = &quot;dlrm&quot;,
                              max_batchsize = 4096,
                              hit_rate_threshold = 0.6,
                              dense_model_file = &quot;./_dense_10000.model&quot;,
                              sparse_model_files = [&quot;./0_sparse_10000.model&quot;],
                              device_id = 0,
                              use_gpu_embedding_cache = True,
                              cache_size_percentage = 0.2,
                              i64_input_key = True)
inference_session = CreateInferenceSession(&quot;dlrm_ecommerce.json&quot;, inference_params)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[HUGECTR][23:21:46][INFO][RANK0]: default_emb_vec_value is not specified using default: 0.000000
[HUGECTR][23:21:46][INFO][RANK0]: Created parallel (16 partitions) blank database backend in local memory!
[HUGECTR][23:22:51][INFO][RANK0]: ParallelLocalMemory backend. Table: dlrm#0. Inserted 33653303 / 33653303 pairs.
[HUGECTR][23:22:51][INFO][RANK0]: Cached 0.000000 * 33653303 embeddings in CPU memory database!
[HUGECTR][23:22:52][INFO][RANK0]: Create embedding cache in device 0.
[HUGECTR][23:22:53][INFO][RANK0]: create_refreshspace2
[HUGECTR][23:22:53][INFO][RANK0]: Global seed is 813179416
[HUGECTR][23:22:53][INFO][RANK0]: Device to NUMA mapping:
  GPU 0 -&gt;  node 0

[HUGECTR][23:22:54][WARNING][RANK0]: Peer-to-peer access cannot be fully enabled.
[HUGECTR][23:22:54][INFO][RANK0]: Start all2all warmup
[HUGECTR][23:22:54][INFO][RANK0]: End all2all warmup
[HUGECTR][23:22:54][INFO][RANK0]: Use mixed precision: 0
[HUGECTR][23:22:54][INFO][RANK0]: start create embedding for inference
[HUGECTR][23:22:54][INFO][RANK0]: sparse_input name data1
[HUGECTR][23:22:54][INFO][RANK0]: create embedding for inference success
[HUGECTR][23:22:54][INFO][RANK0]: Inference stage skip BinaryCrossEntropyLoss layer, replaced by Sigmoid layer
</pre></div></div>
</div>
</div>
<div class="section" id="Reading-and-prepare-the-data">
<h3>Reading and prepare the data<a class="headerlink" href="#Reading-and-prepare-the-data" title="Permalink to this headline"></a></h3>
<p>We first read the NVTabular processed data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import pandas as pd

nvtdata_test = pd.read_parquet(&#39;./nvtabular_temp/output/test/part_0.parquet&#39;)
nvtdata_test.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ts_hour_user_id_brand_cross</th>
      <th>ts_weekday_user_id_brand_cross</th>
      <th>cat_0_user_id_brand_cross</th>
      <th>cat_1_user_id_brand_cross</th>
      <th>cat_2_user_id_brand_cross</th>
      <th>product_id_user_id_cross</th>
      <th>brand_user_id_cross</th>
      <th>ts_hour_user_id_cross</th>
      <th>ts_minute_user_id_cross</th>
      <th>price</th>
      <th>ts_weekday</th>
      <th>ts_day</th>
      <th>ts_month</th>
      <th>TE_brand_target_TE</th>
      <th>TE_user_id_target_TE</th>
      <th>TE_product_id_target_TE</th>
      <th>TE_cat_2_target_TE</th>
      <th>TE_ts_weekday_ts_day_target_TE</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>-0.823432</td>
      <td>-1.490397</td>
      <td>1.272925</td>
      <td>-0.270035</td>
      <td>-1.287369</td>
      <td>0.390281</td>
      <td>0.390281</td>
      <td>-1.285848</td>
      <td>0.445558</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>-0.627107</td>
      <td>-0.996241</td>
      <td>0.581269</td>
      <td>-0.270035</td>
      <td>0.306095</td>
      <td>0.390281</td>
      <td>0.339375</td>
      <td>0.352659</td>
      <td>0.396743</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>-0.299060</td>
      <td>-0.996241</td>
      <td>1.388201</td>
      <td>-0.270035</td>
      <td>0.364552</td>
      <td>0.390281</td>
      <td>0.443069</td>
      <td>0.459563</td>
      <td>0.433425</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>-0.037364</td>
      <td>1.474540</td>
      <td>-0.456215</td>
      <td>-0.270035</td>
      <td>0.466595</td>
      <td>0.390281</td>
      <td>0.431157</td>
      <td>0.460040</td>
      <td>0.407608</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>-0.704362</td>
      <td>-0.502085</td>
      <td>-0.917319</td>
      <td>-0.270035</td>
      <td>0.218853</td>
      <td>0.390281</td>
      <td>0.274339</td>
      <td>-1.285741</td>
      <td>0.428683</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>con_feats = [&#39;price&#39;,
 &#39;ts_weekday&#39;,
 &#39;ts_day&#39;,
 &#39;ts_month&#39;,
 &#39;TE_brand_target_TE&#39;,
 &#39;TE_user_id_target_TE&#39;,
 &#39;TE_product_id_target_TE&#39;,
 &#39;TE_cat_2_target_TE&#39;,
 &#39;TE_ts_weekday_ts_day_target_TE&#39;]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cat_feats = [&#39;ts_hour_user_id_brand_cross&#39;,
 &#39;ts_weekday_user_id_brand_cross&#39;,
 &#39;cat_0_user_id_brand_cross&#39;,
 &#39;cat_1_user_id_brand_cross&#39;,
 &#39;cat_2_user_id_brand_cross&#39;,
 &#39;product_id_user_id_cross&#39;,
 &#39;brand_user_id_cross&#39;,
 &#39;ts_hour_user_id_cross&#39;,
 &#39;ts_minute_user_id_cross&#39;]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>emb_size = [4427037, 3961156, 2877223, 2890639, 2159304, 4398425, 3009092, 3999369, 5931061]
</pre></div>
</div>
</div>
</div>
<div class="section" id="Converting-data-to-CSR-format">
<h3>Converting data to CSR format<a class="headerlink" href="#Converting-data-to-CSR-format" title="Permalink to this headline"></a></h3>
<p>HugeCTR expects data in CSR format for inference. One important thing to note is that NVTabular requires categorical variables to occupy different integer ranges. For example, if there are 10 users and 10 items, then the users should be encoded in the 0-9 range, while items should be in the 10-19 range. NVTabular encodes both users and items in the 0-9 ranges.</p>
<p>For this reason, we need to shift the keys of the categorical variable produced by NVTabular to comply with HugeCTR.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import numpy as np
shift = np.insert(np.cumsum(emb_size), 0, 0)[:-1]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cat_data = nvtdata_test[cat_feats].values + shift
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dense_data = nvtdata_test[con_feats].values
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def infer_batch(inference_session, dense_data_batch, cat_data_batch):
    dense_features = list(dense_data_batch.flatten())
    embedding_columns = list(cat_data_batch.flatten())
    row_ptrs= list(range(0,len(embedding_columns)+1))
    output = inference_session.predict(dense_features, embedding_columns, row_ptrs)
    return output
</pre></div>
</div>
</div>
<p>Now we are ready to carry out inference on the test set.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>batch_size = 4096
num_batches = (len(dense_data) // batch_size) + 1
batch_idx = np.array_split(np.arange(len(dense_data)), num_batches)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!pip install tqdm
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Looking in indexes: https://pypi.org/simple, https://pypi.ngc.nvidia.com
Requirement already satisfied: tqdm in /usr/local/lib/python3.8/dist-packages (4.62.3)
<span class="ansi-yellow-fg">WARNING: Running pip as the &#39;root&#39; user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</span>
<span class="ansi-yellow-fg">WARNING: You are using pip version 21.2.4; however, version 21.3.1 is available.
You should consider upgrading via the &#39;/usr/bin/python -m pip install --upgrade pip&#39; command.</span>
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from tqdm import tqdm

labels = []
for batch_id in tqdm(batch_idx):
    dense_data_batch = dense_data[batch_id]
    cat_data_batch = cat_data[batch_id]
    results = infer_batch(inference_session, dense_data_batch, cat_data_batch)
    labels.extend(results)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>len(labels)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2772486
</pre></div></div>
</div>
</div>
<div class="section" id="Computing-the-test-AUC-value">
<h3>Computing the test AUC value<a class="headerlink" href="#Computing-the-test-AUC-value" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ground_truth = nvtdata_test[&#39;target&#39;].values
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.metrics import roc_auc_score

roc_auc_score(ground_truth, labels)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.5565971533171648
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Conclusion">
<h2>Conclusion<a class="headerlink" href="#Conclusion" title="Permalink to this headline"></a></h2>
<p>In this notebook, we have walked you through the process of preprocessing the data, train a DLRM model with HugeCTR, then carrying out inference with the HugeCTR Python interface. Try this workflow on your data and let us know your feedback.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="continuous_training.html" class="btn btn-neutral float-left" title="HugeCTR Continuous Training" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="movie-lens-example.html" class="btn btn-neutral float-right" title="HugeCTR demo on Movie lens data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: master
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Branches</dt>
      <dd><a href="ecommerce-example.html">master</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>